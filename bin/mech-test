#!/usr/bin/env perl

# Test the extrema.

use strict;
use warnings;

use Test::More;
use Test::WWW::Mechanize;

my $base = 'http://0.0.0.0:5000';

my $disordered = 1; # 0 for "no disorder"

my ( $plus, $minus );
if ( $disordered ) {
    ( $plus, $minus ) = ( 10, 1 );
}
else {
    ( $plus, $minus ) = ( 1, 10 );
}

# Read-in quiz questions
my $file = 'public/dpda-questions.txt';
my @quiz;
open my $fh, '<', $file or die "Can't read $file: $!";
while ( my $line = <$fh> ) {
    chomp $line;
    push @quiz, $line;
}
close $fh;

my $mech = Test::WWW::Mechanize->new();

$mech->get("$base/question");

if ( $mech->status eq '200' ) {
    for my $i ( 0 .. @quiz - 1 ) {
        my $question_num = $mech->scrape_text_by_id('question_num');

        my @question = split /\|/, $quiz[$question_num];
        my $inv      = ( split /\s+/, $question[0] )[2];

        $mech->submit_form_ok(
            {
                form_number => 1,
                fields      => {
                    answer => $inv eq '+' ? $plus : $minus,
                },
            },
            "submit form for $inv question $question_num"
        );
    }

    is $mech->base, "$base/chart", '/chart';
}
else {
    print "Can't connect to $base\n";
}

done_testing();
